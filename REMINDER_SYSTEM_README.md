# Система напоминаний для водителей

## Описание

Система автоматически отправляет напоминания водителям за 1 час до начала поездки и уведомляет ответственных лиц, если водитель не подтверждает готовность в течение 15 минут.

## Функциональность

1. **Автоматические напоминания**: За 1 час до поездки водитель получает сообщение с кнопкой "✅ Подтверждаю"
2. **Отслеживание подтверждений**: Система отслеживает, подтвердил ли водитель готовность
3. **Уведомления ответственному**: Если водитель не подтвердил в течение 15 минут, ответственное лицо получает уведомление
4. **Логирование**: Все действия записываются в лог-файлы

## Требования

- PHP 7.4+
- Telegram Bot API
- Bitrix24 REST API (CRest)
- Composer с установленными зависимостями

## Установка

### 1. Настройка полей в Bitrix24

Добавьте следующие пользовательские поля в CRM сделки:

- `UF_CRM_1751638618` - Отправлено напоминание (дата/время)
- `UF_CRM_1751638619` - Подтверждено водителем (дата/время)  
- `UF_CRM_1751638620` - Отправлено уведомление ответственному (дата/время)

### 2. Настройка токена бота

Отредактируйте файл `reminder_scheduler.php` и замените `YOUR_BOT_TOKEN_HERE` на ваш токен Telegram бота.

### 3. Настройка cron

Выполните команду для автоматической настройки cron:

```bash
chmod +x setup_cron.sh
./setup_cron.sh
```

Или настройте вручную:

```bash
# Открыть crontab для редактирования
crontab -e

# Добавить строку (замените путь на ваш)
*/5 * * * * php /path/to/your/project/reminder_scheduler.php >> /path/to/your/project/logs/cron.log 2>&1
```

## Структура файлов

- `botManager.php` - Основной класс с методами для работы с напоминаниями
- `reminder_scheduler.php` - Скрипт планировщика для cron
- `setup_cron.sh` - Скрипт автоматической настройки cron
- `logs/` - Директория для логов

## Новые методы в botManager

### `sendTravelReminder(int $dealId, Api $telegram): bool`
Отправляет напоминание водителю за 1 час до поездки.

### `confirmReminderHandle(int $dealId, Api $telegram, Update $result): void`
Обрабатывает подтверждение водителя о готовности.

### `sendResponsibleNotification(int $dealId, Api $telegram): bool`
Отправляет уведомление ответственному лицу.

### `checkAndSendReminders(Api $telegram): array`
Основной метод для проверки и отправки всех напоминаний.

## Логирование

Система создает два лог-файла:

1. `logs/reminder_scheduler.log` - Логи работы скрипта напоминаний
2. `logs/cron.log` - Логи выполнения cron задач

## Тестирование

Для проверки работы системы выполните:

```bash
# Тестовый запуск
php reminder_scheduler.php

# Просмотр логов
tail -f logs/reminder_scheduler.log
tail -f logs/cron.log
```

## Мониторинг

Проверяйте статус cron задачи:

```bash
# Просмотр активных cron задач
crontab -l

# Проверка логов cron
grep CRON /var/log/syslog
```

## Устранение неполадок

### Скрипт не выполняется
1. Проверьте права доступа: `chmod +x reminder_scheduler.php`
2. Проверьте cron: `crontab -l`
3. Проверьте логи: `tail -f logs/cron.log`

### Ошибки в логах
1. Проверьте токен бота в `reminder_scheduler.php`
2. Убедитесь, что CRest работает корректно
3. Проверьте права доступа к директории `logs/`

### Напоминания не отправляются
1. Проверьте статус сделок в Bitrix24
2. Убедитесь, что поля напоминаний настроены корректно
3. Проверьте логи на наличие ошибок

## Безопасность

- Храните токен бота в безопасном месте
- Ограничьте доступ к директории `logs/`
- Регулярно проверяйте логи на подозрительную активность

## Поддержка

При возникновении проблем проверьте:
1. Логи системы
2. Настройки cron
3. Права доступа к файлам
4. Корректность токена бота







