<?php
/**
 * Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ð™ Ñ‚ÐµÑÑ‚ webhook Ð´Ð»Ñ MeetRide Bot
 * Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸, ÐÐ• Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
 */

echo "ðŸ§ª Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ð™ Ñ‚ÐµÑÑ‚ webhook MeetRide Bot\n";
echo "======================================\n\n";

// Ð˜Ð¼Ð¸Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²ÑƒÑŽ ÑÐ´ÐµÐ»ÐºÑƒ
$testDeal = [
    'ID' => '999',
    'TITLE' => 'Ð—Ð°ÑÐ²ÐºÐ°: 123456',
    'STAGE_ID' => 'PREPARATION',
    'UF_CRM_1751269222959' => '2025-01-15 14:30:00', // Ð”Ð°Ñ‚Ð°
    'UF_CRM_1751269222958' => 'ÐÑÑ€Ð¾Ð¿Ð¾Ñ€Ñ‚ Ð’Ð¾Ð»Ð³Ð¾Ð³Ñ€Ð°Ð´', // ÐžÑ‚ÐºÑƒÐ´Ð°
    'UF_CRM_1751269222957' => 'Ð¦ÐµÐ½Ñ‚Ñ€ Ð³Ð¾Ñ€Ð¾Ð´Ð°, ÑƒÐ». Ð›ÐµÐ½Ð¸Ð½Ð° 1', // ÐšÑƒÐ´Ð°
    'UF_CRM_1751269222960' => '5000|RUB', // Ð¡ÑƒÐ¼Ð¼Ð°
    'UF_CRM_1751269222961' => 'Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ', // Ð”Ð¾Ð¿ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ
    'UF_CRM_1751271798896' => 'Ð˜Ð²Ð°Ð½ ÐŸÐµÑ‚Ñ€Ð¾Ð² (79001234567), ÐœÐ°Ñ€Ð¸Ñ Ð¡Ð¸Ð´Ð¾Ñ€Ð¾Ð²Ð° (79007654321)', // ÐŸÐ°ÑÑÐ°Ð¶Ð¸Ñ€Ñ‹
    'UF_CRM_1751271841129' => 'Ð¡ÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ - ÐÐ• Ð”ÐžÐ›Ð–ÐÐž ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ¢Ð¬Ð¡Ð¯' // Ð¡ÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ
];

echo "ðŸ“‹ Ð¢ÐµÑÑ‚Ð¾Ð²Ð°Ñ ÑÐ´ÐµÐ»ÐºÐ°:\n";
echo "   ID: " . $testDeal['ID'] . "\n";
echo "   TITLE: " . $testDeal['TITLE'] . "\n";
echo "   Ð¡Ñ‚Ð°Ð´Ð¸Ñ: " . $testDeal['STAGE_ID'] . "\n\n";

// Ð¢ÐµÑÑ‚ 1: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð½Ð¾Ð¼ÐµÑ€Ð° Ð·Ð°ÐºÐ°Ð·Ð°
echo "1. Ð¢ÐµÑÑ‚ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð½Ð¾Ð¼ÐµÑ€Ð° Ð·Ð°ÐºÐ°Ð·Ð°:\n";
$orderNumber = $testDeal['TITLE'];
if (strpos($orderNumber, 'Ð—Ð°ÑÐ²ÐºÐ°: ') === 0) {
    $orderNumber = substr($orderNumber, 8);
}
if (strpos($orderNumber, ':') !== false) {
    $orderNumber = trim(explode(':', $orderNumber)[1]);
}
echo "   Ð˜ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹: '" . $testDeal['TITLE'] . "'\n";
echo "   ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ñ‹Ð¹: '$orderNumber'\n";
echo "   âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾\n\n";

// Ð¢ÐµÑÑ‚ 2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹
echo "2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹:\n";
$testGroupId = -1001649190984;
$productionGroupId = -1002544521661;

if ($testGroupId == -1001649190984) {
    echo "   âœ… Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¢Ð•Ð¡Ð¢ÐžÐ’ÐÐ¯ Ð³Ñ€ÑƒÐ¿Ð¿Ð°: $testGroupId\n";
} else {
    echo "   âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ! ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð°: $testGroupId\n";
}

if ($testGroupId != $productionGroupId) {
    echo "   âœ… Ð‘ÐžÐ•Ð’ÐÐ¯ Ð³Ñ€ÑƒÐ¿Ð¿Ð° ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ\n";
} else {
    echo "   âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ! Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð‘ÐžÐ•Ð’ÐÐ¯ Ð³Ñ€ÑƒÐ¿Ð¿Ð°!\n";
}
echo "\n";

// Ð¢ÐµÑÑ‚ 3: Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (Ð±ÐµÐ· Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸)
echo "3. Ð¢ÐµÑÑ‚ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹:\n";

// Ð˜Ð¼Ð¸Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ orderTextForGroup
$additionalConditions = $testDeal['UF_CRM_1751269222961'];
$dateText = $testDeal['UF_CRM_1751269222959'];
if ($dateText) {
    $date = new DateTime($dateText);
    $dateText = $date->format('d.m.Y H:i');
}

$fromAddress = $testDeal['UF_CRM_1751269222958'];
$toAddress = $testDeal['UF_CRM_1751269222957'];

$sumText = $testDeal['UF_CRM_1751269222960'];
if ($sumText) {
    $sumText = str_replace('|RUB', '', $sumText);
}

$orderNumber = $testDeal['TITLE'];
if (strpos($orderNumber, ':') !== false) {
    $orderNumber = trim(explode(':', $orderNumber)[1]);
}

$groupMessage = <<<HTML
#ï¸âƒ£ $orderNumber

ðŸ“† $dateText

ðŸ…°ï¸ $fromAddress

ðŸ…±ï¸ $toAddress

â„¹ï¸ $additionalConditions

ðŸ’° $sumText
HTML;

echo "   Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ (Ð‘Ð•Ð— Ð¿Ð°ÑÑÐ°Ð¶Ð¸Ñ€Ð¾Ð²):\n";
echo "   " . str_replace("\n", "\n   ", $groupMessage) . "\n\n";

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ð°ÑÑÐ°Ð¶Ð¸Ñ€Ñ‹ ÐÐ• Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸
if (strpos($groupMessage, 'ÐŸÐ°ÑÑÐ°Ð¶Ð¸Ñ€Ñ‹') === false) {
    echo "   âœ… Ð’ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ ÐÐ•Ð¢ Ð¿Ð°ÑÑÐ°Ð¶Ð¸Ñ€Ð¾Ð²\n";
} else {
    echo "   âŒ Ð’ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ Ð•Ð¡Ð¢Ð¬ Ð¿Ð°ÑÑÐ°Ð¶Ð¸Ñ€Ñ‹!\n";
}

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ ÐÐ• Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸
if (strpos($groupMessage, 'Ð¡ÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ') === false) {
    echo "   âœ… Ð¡ÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ ÐÐ• Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸\n";
} else {
    echo "   âŒ Ð¡ÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸!\n";
}

echo "\n";

// Ð¢ÐµÑÑ‚ 4: Ð˜Ð¼Ð¸Ñ‚Ð°Ñ†Ð¸Ñ Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŽ
echo "4. Ð¢ÐµÑÑ‚ Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŽ:\n";

$passengers = $testDeal['UF_CRM_1751271798896'];

$driverMessage = <<<HTML
ðŸš— Ð’Ð°ÑˆÐ° Ð·Ð°ÑÐ²ÐºÐ° #$orderNumber

ðŸ“† Ð”Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ: $dateText

ðŸ…°ï¸ ÐžÑ‚ÐºÑƒÐ´Ð°: $fromAddress

ðŸ…±ï¸ ÐšÑƒÐ´Ð°: $toAddress

ðŸ‘¥ ÐŸÐ°ÑÑÐ°Ð¶Ð¸Ñ€Ñ‹: $passengers

â„¹ï¸ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ: $additionalConditions

ðŸ’° Ð¡ÑƒÐ¼Ð¼Ð°: $sumText

ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ" ÐºÐ¾Ð³Ð´Ð° Ð±ÑƒÐ´ÐµÑ‚Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ ÐµÑ…Ð°Ñ‚ÑŒ
HTML;

echo "   Ð›Ð¸Ñ‡Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ (Ð¡ Ð¿Ð°ÑÑÐ°Ð¶Ð¸Ñ€Ð°Ð¼Ð¸):\n";
echo "   " . str_replace("\n", "\n   ", $driverMessage) . "\n\n";

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ð°ÑÑÐ°Ð¶Ð¸Ñ€Ñ‹ Ð•Ð¡Ð¢Ð¬ Ð² Ð»Ð¸Ñ‡Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸
if (strpos($driverMessage, 'ÐŸÐ°ÑÑÐ°Ð¶Ð¸Ñ€Ñ‹') !== false) {
    echo "   âœ… Ð’ Ð»Ð¸Ñ‡Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ Ð•Ð¡Ð¢Ð¬ Ð¿Ð°ÑÑÐ°Ð¶Ð¸Ñ€Ñ‹\n";
} else {
    echo "   âŒ Ð’ Ð»Ð¸Ñ‡Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ ÐÐ•Ð¢ Ð¿Ð°ÑÑÐ°Ð¶Ð¸Ñ€Ð¾Ð²!\n";
}

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ ÐÐ• Ð² Ð»Ð¸Ñ‡Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸
if (strpos($driverMessage, 'Ð¡ÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ') === false) {
    echo "   âœ… Ð¡ÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ ÐÐ• Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð² Ð»Ð¸Ñ‡Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸\n";
} else {
    echo "   âŒ Ð¡ÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð² Ð»Ð¸Ñ‡Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸!\n";
}

echo "\n";

echo "ðŸŽ‰ Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ð™ Ñ‚ÐµÑÑ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!\n";
echo "============================\n";
echo "âœ… Ð’ÑÐµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾\n";
echo "âœ… Ð‘Ð¾ÐµÐ²Ð¾Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ðµ Ð·Ð°Ñ‚Ñ€Ð¾Ð½ÑƒÑ‚\n";
echo "âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼Ñƒ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ\n";
?>
