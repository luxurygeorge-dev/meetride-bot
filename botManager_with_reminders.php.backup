<?php

namespace Store;

use Telegram\Bot\Api;
use Telegram\Bot\Objects\Message;
use Telegram\Bot\Keyboard\Keyboard;
use Telegram\Bot\Objects\Update;
use Illuminate\Support\Collection;


include('vendor/autoload.php');

class botManager {
//callback pattern =   action_dealId
    public const DRIVER_ID_FIELD                = 'UF_CRM_1751272181';
    public const DRIVER_TELEGRAM_ID_FIELD       = 'UF_CRM_1751185017761';
    public const ADDRESS_FROM_FIELD             = 'UF_CRM_1751269147414';
    public const ADDRESS_FROM_FIELD_SERVICE     = 'UF_CRM_1751638512';
    public const ADDRESS_TO_FIELD               = 'UF_CRM_1751269175432';
    public const ADDRESS_TO_FIELD_SERVICE       = 'UF_CRM_1751638529';
    public const ADDITIONAL_CONDITIONS_FIELD    = 'UF_CRM_1751269256380';
    public const DRIVER_SUM_FIELD               = 'UF_CRM_1751271862251';
    public const DRIVER_SUM_FIELD_SERVICE       = 'UF_CRM_1751638441407';
    public const TRAVEL_DATE_TIME_FIELD         = 'UF_CRM_1751269222959';
    public const TRAVEL_DATE_TIME_FIELD_SERVICE = 'UF_CRM_1751638617';
    public const DRIVER_ACCEPTED_STAGE_ID       = 'EXECUTING';
    public const NEW_DEAL_STAGE_ID              = 'NEW';
    public const DRIVER_CHOICE_STAGE_ID         = 'PREPARATION';
    public const TRAVEL_STARTED_STAGE_ID         = 'EXECUTING';
    public const FINISH_STAGE_ID         = 'FINAL_INVOICE';
    public const DRIVER_CONTACT_TYPE            = 'UC_C7O5J7';

    public static function newDealMessage(int $dealid, Api $telegram): ?Message {
        require_once('/home/telegramBot/crest/crest.php');
        $deal = \CRest::call('crm.deal.get', ['id' => $dealid])['result'];
        if(empty($deal['ID'])) {
            return null;
        }
        $driver = \CRest::call('crm.contact.get', ['id' => $deal[botManager::DRIVER_ID_FIELD],'select' =>[botManager::DRIVER_TELEGRAM_ID_FIELD]])['result'];

        if(!$driver) {
            return null;
        }
        $driverTelegramId = (int) $driver[botManager::DRIVER_TELEGRAM_ID_FIELD];
        if(!$driverTelegramId) {
            return null;
        }
        $keyboard = new Keyboard();

        // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
        $keyboard->inline();

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        $keyboard->row([
                Keyboard::inlineButton(['text' => '‚úÖ –ü—Ä–∏–Ω—è—Ç—å', 'callback_data' => "accept_$dealid"]),
                Keyboard::inlineButton(['text' => '‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è', 'callback_data' => "reject_$dealid"]),
        ]);

        return $telegram->sendMessage(
                [
                        'chat_id'      => $driverTelegramId,
                        'text'         => botManager::orderText($deal),
                        'reply_markup' => $keyboard,
                ]
        );
    }

    public static function buttonHanlde(Api $telegram, Update $result) {

        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();

        $data = $result->callbackQuery->data;
        if ($data) {
            $buttonData = explode('_', $data);
            $dealId = (int) $buttonData[1];
            $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
            if(empty($deal['ID'])) {
                $telegram->answerCallbackQuery([
                        'callback_query_id' => $result->callbackQuery->id,
                        'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        'show_alert' => false
                ]);
                exit;
            }
            if(
                    $deal['STAGE_ID'] == botManager::FINISH_STAGE_ID
                    || $deal['STAGE_ID'] =='LOSE'
                    || $deal['STAGE_ID'] == 'WON'
                    || $deal['STAGE_ID'] == botManager::NEW_DEAL_STAGE_ID
            ) {
                $telegram->sendMessage(
                        [
                                'chat_id' => $chatId,
                                'text'    => "–ó–∞—è–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞",
                        ]
                );
                $telegram->answerCallbackQuery([
                        'callback_query_id' => $result->callbackQuery->id,
                        'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        'show_alert' => false
                ]);
                exit;
            }
            match ($buttonData[0]) {
                'accept' => botManager::driverAcceptHandle($telegram, $result, $dealId),
                'reject' => botManager::driverRejectHandle($telegram, $result, $dealId),
                "groupAccept" => botManager::groupAcceptHandle($dealId, $chatId, $telegram, $result, $buttonData[2]),
                "start" => botManager::travelStartHandle($dealId, $telegram, $result),
                "startYes" => botManager::travelStartYesHandle($dealId, $telegram, $result),
                "startNo" => botManager::travelStartNoHandle($telegram, $result, $dealId),
                "cancel" => botManager::cancelHandle($dealId, $telegram, $result),
                "cancelYes" => self::cancelYesHandle($telegram, $result, $dealId),
                "cancelNo" => self::cancelNoHandle($dealId, $telegram, $result),
                "finish" => self::finishHandle($dealId, $telegram, $result),
                "finishYes" => self::finishYesHandle($dealId, $result, $telegram),
                "finishNo" => self::finishNoHandle($dealId, $telegram, $result),
                default => botManager::writeToLog("/logs/xxx.php", $buttonData[0],'$buttonData[0]', 'a'),
            };

            exit;
        }
    }

    public static function driverAcceptHandle (Api $telegram, Update $result, int $dealId): void {
        require_once(__DIR__ . '/../crest/crest.php');
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }

        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();
        if(!$deal[botManager::DRIVER_ID_FIELD]) {
            $telegram->sendMessage(
                    [
                            'chat_id' => $chatId,
                            'text'    => "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –æ–±—â–µ–π —Ä–∞—Å—Å—ã–ª–∫–∏",
                    ]
            );
            $telegram->deleteMessage([
                    'chat_id'    => $chatId,
                    'message_id' => $message->getMessageId(),

            ]);

            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            return;
        }


        $keyboard = new Keyboard();

        // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
        $keyboard->inline();

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        $keyboard->row([
                Keyboard::inlineButton(['text' => '‚úÖ –ù–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ', 'callback_data' => "start_$dealId"]),
                Keyboard::inlineButton(['text' => '‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è', 'callback_data' => "reject_$dealId"]),
        ]);
        $telegram->editMessageReplyMarkup([
                'chat_id' => $chatId,
                'message_id' => $message->getMessageId(),
                'reply_markup' => $keyboard
        ]);
        $dealUpdate = \CRest::call('crm.deal.update', ['id' => $dealId, 'fields'=>[
                'STAGE_ID'=>botManager::DRIVER_ACCEPTED_STAGE_ID,
                botManager::DRIVER_SUM_FIELD_SERVICE=>$deal[botManager::DRIVER_SUM_FIELD],
                botManager::ADDRESS_FROM_FIELD_SERVICE=>$deal[botManager::ADDRESS_FROM_FIELD],
                botManager::ADDRESS_TO_FIELD_SERVICE=>$deal[botManager::ADDRESS_TO_FIELD],
                botManager::TRAVEL_DATE_TIME_FIELD_SERVICE=>$deal[botManager::TRAVEL_DATE_TIME_FIELD]
        ]
        ]);
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function cancelHandle(int $dealId, Api $telegram, Update $result) {
        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();
        $keyboard = new Keyboard();

        // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
        $keyboard->inline();

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        $keyboard->row([
                Keyboard::inlineButton(['text' => '–î–∞', 'callback_data' => "cancelYes_$dealId"]),
                Keyboard::inlineButton(['text' => '–ù–µ—Ç', 'callback_data' => "cancelNo_$dealId"]),
        ]);
        $telegram->editMessageReplyMarkup([
                'chat_id' => $chatId,
                'message_id' => $message->getMessageId(),
                'reply_markup' => $keyboard
        ]);
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function finishHandle(int $dealId, Api $telegram, Update $result) {
        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();
        $keyboard = new Keyboard();

        // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
        $keyboard->inline();

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        $keyboard->row([
                Keyboard::inlineButton(['text' => '–î–∞', 'callback_data' => "finishYes_$dealId"]),
                Keyboard::inlineButton(['text' => '–ù–µ—Ç', 'callback_data' => "finishNo_$dealId"]),
        ]);
        $telegram->editMessageReplyMarkup([
                'chat_id' => $chatId,
                'message_id' => $message->getMessageId(),
                'reply_markup' => $keyboard
        ]);
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function finishYesHandle($dealId, Update $result, Api $telegram) {
        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();
        $dealUpdate = \CRest::call('crm.deal.update', ['id' => $dealId, 'fields'=>[
                'STAGE_ID'=>botManager::FINISH_STAGE_ID,
        ]
        ]);
        
        // –í–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Å –æ—Ç–º–µ—Ç–∫–æ–π –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
        $telegram->editMessageText([
                'chat_id' => $chatId,
                'message_id' => $message->getMessageId(),
                'text' => $message->getText() . "\n\n‚úÖ –ó–ê–Ø–í–ö–ê –í–´–ü–û–õ–ù–ï–ù–ê",
        ]);
        
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è!', 
                'show_alert' => false
        ]);
    }

    public static function finishNoHandle(int $dealId, Api $telegram, Update $result) {
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();
        $dealUpdate = \CRest::call('crm.deal.update', [
                        'id'     => $dealId,
                        'fields' => ['STAGE_ID' => botManager::TRAVEL_STARTED_STAGE_ID],
                ]
        );
        $keyboard = new Keyboard();

        // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
        $keyboard->inline();

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        $keyboard->row([
                Keyboard::inlineButton(['text' => 'üèÅ –ó–∞—è–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'callback_data' => "finish_$dealId"]),
                Keyboard::inlineButton(['text' => '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ', 'callback_data' => "cancel_$dealId"]),
        ]);
        $telegram->editMessageReplyMarkup([
                'chat_id' => $chatId,
                'message_id' => $message->getMessageId(),
                'reply_markup' => $keyboard
        ]);
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function cancelYesHandle(Api $telegram, Update $result, int $dealId) {
        require_once(__DIR__ . '/../crest/crest.php');
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();


        $keyboard = new Keyboard();

        // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
        $keyboard->inline();

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        $keyboard->row([
                Keyboard::inlineButton(['text' => '‚úÖ –ù–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ', 'callback_data' => "start_$dealId"]),
                Keyboard::inlineButton(['text' => '‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è', 'callback_data' => "reject_$dealId"]),
        ]);
        $telegram->editMessageReplyMarkup([
                'chat_id' => $chatId,
                'message_id' => $message->getMessageId(),
                'reply_markup' => $keyboard
        ]);
        $dealUpdate = \CRest::call('crm.deal.update', ['id' => $dealId, 'fields'=>[
                'STAGE_ID'=>botManager::DRIVER_ACCEPTED_STAGE_ID,
        ]
        ]);
        $notify = \CRest::call('im.notify.system.add', [
                'USER_ID' => $deal['ASSIGNED_BY_ID'],
                'MESSAGE'=>"–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏". " <a href = 'https://b24-cprnr5.bitrix24.ru/crm/deal/details/$dealId/'>{$deal['TITLE']}</a>",

                ]
        );
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);

    }

    public static function cancelNoHandle(int $dealId, Api $telegram, Update $result) {
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();
        $dealUpdate = \CRest::call('crm.deal.update', [
                        'id'     => $dealId,
                        'fields' => ['STAGE_ID' => botManager::TRAVEL_STARTED_STAGE_ID],
                ]
        );
        $keyboard = new Keyboard();

        // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
        $keyboard->inline();

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        $keyboard->row([
                Keyboard::inlineButton(['text' => 'üèÅ –ó–∞—è–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'callback_data' => "finish_$dealId"]),
                Keyboard::inlineButton(['text' => '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ', 'callback_data' => "cancel_$dealId"]),
        ]);
        $telegram->editMessageReplyMarkup([
                'chat_id' => $chatId,
                'message_id' => $message->getMessageId(),
                'reply_markup' => $keyboard
        ]);
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function travelStartYesHandle(int $dealId, Api $telegram, Update $result) {
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();
        $dealUpdate = \CRest::call('crm.deal.update', [
                        'id'     => $dealId,
                        'fields' => ['STAGE_ID' => botManager::TRAVEL_STARTED_STAGE_ID],
                ]
        );
        $keyboard = new Keyboard();

        // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
        $keyboard->inline();

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        $keyboard->row([
                Keyboard::inlineButton(['text' => 'üèÅ –ó–∞—è–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'callback_data' => "finish_$dealId"]),
                Keyboard::inlineButton(['text' => '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ', 'callback_data' => "cancel_$dealId"]),
        ]);
        $telegram->editMessageReplyMarkup([
                'chat_id' => $chatId,
                'message_id' => $message->getMessageId(),
                'reply_markup' => $keyboard
        ]);
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function travelStartNoHandle(Api $telegram, Update $result, int $dealId) {
        require_once(__DIR__ . '/../crest/crest.php');
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();


        $keyboard = new Keyboard();

        // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
        $keyboard->inline();

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        $keyboard->row([
                Keyboard::inlineButton(['text' => '‚úÖ –ù–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ', 'callback_data' => "start_$dealId"]),
                Keyboard::inlineButton(['text' => '‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è', 'callback_data' => "reject_$dealId"]),
        ]);
        $telegram->editMessageReplyMarkup([
                'chat_id' => $chatId,
                'message_id' => $message->getMessageId(),
                'reply_markup' => $keyboard
        ]);

        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function travelStartHandle(int $dealId, Api $telegram, Update $result) {
        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();
        $keyboard = new Keyboard();

        // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
        $keyboard->inline();

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        $keyboard->row([
                Keyboard::inlineButton(['text' => '–î–∞', 'callback_data' => "startYes_$dealId"]),
                Keyboard::inlineButton(['text' => '–ù–µ—Ç', 'callback_data' => "startNo_$dealId"]),
        ]);
        $telegram->editMessageReplyMarkup([
                'chat_id' => $chatId,
                'message_id' => $message->getMessageId(),
                'reply_markup' => $keyboard
        ]);
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function driverRejectHandle (Api $telegram, Update $result, int $dealId):void {
        require_once(__DIR__ . '/../crest/crest.php');
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        $message = $result->getMessage();
        $chatId = $message->getChat()->getId();
        $telegram->sendMessage(
                [
                        'chat_id' => $chatId,
                        'text'    => "–≤—ã –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å!",
                ]
        );
        $telegram->deleteMessage([
                'chat_id'    => $chatId,
                'message_id' => $message->getMessageId(),
        ]);
        $dealUpdate = \CRest::call('crm.deal.update', [
                'id' => $dealId,
                'fields'=>[botManager::DRIVER_ID_FIELD => 0]
        ]);
        if($deal[botManager::DRIVER_ID_FIELD] > 0) {
        $notify = \CRest::call('im.notify.system.add', [
                        'USER_ID' => $deal['ASSIGNED_BY_ID'],
                        'MESSAGE'=>"–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç –∑–∞—è–≤–∫–∏". " <a href = 'https://b24-cprnr5.bitrix24.ru/crm/deal/details/$dealId/'>{$deal['TITLE']}</a>",

                ]
        );
        }
        if($deal['STAGE_ID'] == botManager::DRIVER_CHOICE_STAGE_ID) {
        $drivers = \CRest::call('crm.contact.list', ['filter' => ['TYPE_ID'=>botManager::DRIVER_CONTACT_TYPE, '!'.botManager::DRIVER_TELEGRAM_ID_FIELD => $chatId],'select'=>[botManager::DRIVER_TELEGRAM_ID_FIELD]])['result'];
        if(empty($drivers)){
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
            foreach ($drivers as $driver) {
                $driverTelegramId = (int) $driver[botManager::DRIVER_TELEGRAM_ID_FIELD];
                if (!$driverTelegramId) {
                    continue;
                }
                $keyboard = new Keyboard();

                // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
                $keyboard->inline();

                // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
                $keyboard->row([
                        Keyboard::inlineButton([
                                'text'          => '‚úÖ –ü—Ä–∏–Ω—è—Ç—å',
                                'callback_data' => "groupAccept_{$dealId}_{$driver['ID']}",
                        ]),
                        Keyboard::inlineButton(['text' => '‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è', 'callback_data' => "groupReject_$dealId"]),
                ]);

                $telegram->sendMessage(
                        [
                                'chat_id'      => $driverTelegramId,
                                'text'         => botManager::orderText($deal),
                                'reply_markup' => $keyboard,
                        ]
                );
            }

        }
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function dealChangeHandle(int $dealId, Api $telegram, Update $result): void {
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        $driver = \CRest::call('crm.contact.get', ['id' => $deal[botManager::DRIVER_ID_FIELD]])['result'];
        if(empty($driver['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        $driverTelegramId = (int) $driver[botManager::DRIVER_TELEGRAM_ID_FIELD];
        $newSum = null;
        if ($deal[botManager::DRIVER_SUM_FIELD] !== $deal[botManager::DRIVER_SUM_FIELD_SERVICE]) {
            $newSum = (int) $deal[botManager::DRIVER_SUM_FIELD];
        }
        $newAddressFrom=null;
        if ($deal[botManager::ADDRESS_FROM_FIELD] !== $deal[botManager::ADDRESS_FROM_FIELD_SERVICE]) {
            $newAddressFrom = (string) $deal[botManager::ADDRESS_FROM_FIELD];
        }
        $newAddressTo=null;
        if ($deal[botManager::ADDRESS_TO_FIELD] !== $deal[botManager::ADDRESS_TO_FIELD_SERVICE]) {
            $newAddressTo = (string) $deal[botManager::ADDRESS_TO_FIELD];
        }
        $newDate=null;
        if ($deal[botManager::TRAVEL_DATE_TIME_FIELD] !== $deal[botManager::TRAVEL_DATE_TIME_FIELD_SERVICE]) {
            $newDate = (string) $deal[botManager::TRAVEL_DATE_TIME_FIELD];
        }

        $telegram->sendMessage(
                [
                        'chat_id'      => $driverTelegramId,
                        'text'         => botManager::orderText($deal, $newSum, $newAddressFrom, $newAddressTo, $newDate),
                        'parse_mode' => 'HTML',
                ]
        );
        $dealUpdate = \CRest::call('crm.deal.update', ['id' => $dealId, 'fields'=>[
                'STAGE_ID'=>botManager::DRIVER_ACCEPTED_STAGE_ID,
                botManager::DRIVER_SUM_FIELD_SERVICE=>$deal[botManager::DRIVER_SUM_FIELD],
                botManager::ADDRESS_FROM_FIELD_SERVICE=>$deal[botManager::ADDRESS_FROM_FIELD],
                botManager::ADDRESS_TO_FIELD_SERVICE=>$deal[botManager::ADDRESS_TO_FIELD],
                botManager::TRAVEL_DATE_TIME_FIELD_SERVICE=>$deal[botManager::TRAVEL_DATE_TIME_FIELD]
        ]
        ]);
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function commonMailing(int $dealId, Api $telegram, Update $result): void {
        require_once(__DIR__ . '/../crest/crest.php');
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        $dealUpdate = \CRest::call('crm.deal.update', [
                'id' => $dealId,
                'fields'=>[botManager::DRIVER_ID_FIELD => 0]
        ]);
        $drivers = \CRest::call('crm.contact.list', [
                'filter' => [
                        'TYPE_ID'=>botManager::DRIVER_CONTACT_TYPE
                ],
                'select'=>[botManager::DRIVER_TELEGRAM_ID_FIELD]
        ])['result'];

        if(empty($drivers)){
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;

        }
        foreach ($drivers as $driver) {
            $driverTelegramId = (int) $driver[botManager::DRIVER_TELEGRAM_ID_FIELD];
            if(!$driverTelegramId) {
                continue;
            }
            $keyboard = new Keyboard();

            // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
            $keyboard->inline();

            // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
            $keyboard->row([
                    Keyboard::inlineButton(['text' => '‚úÖ –ü—Ä–∏–Ω—è—Ç—å', 'callback_data' => "groupAccept_{$dealId}_{$driver['ID']}"]),
                    Keyboard::inlineButton(['text' => '‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è', 'callback_data' => "reject_$dealId"]),
            ]);

            $telegram->sendMessage(
                    [
                            'chat_id'      => $driverTelegramId,
                            'text'         => botManager::orderText($deal),
                            'reply_markup' => $keyboard,
                    ]
            );

        }
        $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                'show_alert' => false
        ]);
    }

    public static function groupAcceptHandle(int $dealId, string $chatId, Api $telegram, Update $result, $driverId): void {
        $message = $result->getMessage();
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        if(!$deal[botManager::DRIVER_ID_FIELD] && $deal['STAGE_ID'] === botManager::DRIVER_CHOICE_STAGE_ID) {
            \CRest::call('crm.deal.update', ['id' => $dealId, 'fields'=>[botManager::DRIVER_ID_FIELD => $driverId, 'STAGE_ID'=>botManager::DRIVER_ACCEPTED_STAGE_ID]])['result'];
        }
        sleep(3);
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if(empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                    'callback_query_id' => $result->callbackQuery->id,
                    'text' => '', // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    'show_alert' => false
            ]);
            exit;
        }
        if($deal[botManager::DRIVER_ID_FIELD] === $driverId) {
            $keyboard = new Keyboard();

            // 2. –í–∫–ª—é—á–∞–µ–º inline-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–ò —Å–æ–æ–±—â–µ–Ω–∏—è)
            $keyboard->inline();

            // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
            $keyboard->row([
                    Keyboard::inlineButton(['text' => '‚úÖ –ù–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ', 'callback_data' => "start_$dealId"]),
                    Keyboard::inlineButton(['text' => '‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è', 'callback_data' => "reject_$dealId"]),
            ]);
            $telegram->editMessageReplyMarkup([
                    'chat_id' => $chatId,
                    'message_id' => $message->getMessageId(),
                    'reply_markup' => $keyboard
            ]);

        } else {
            $telegram->sendMessage(
                    [
                            'chat_id' => $chatId,
                            'text'    => "–ó–∞—è–≤–∫—É –≤–∑—è–ª –¥—Ä—É–≥–æ–π –≤–æ–¥–∏—Ç–µ–ª—å",
                    ]
            );

            $telegram->deleteMessage([
                    'chat_id'    => $chatId,
                    'message_id' => $message->getMessageId(),
            ]);
        }
    }

    public static function orderText(
            array $deal,
            ?int $newSum = null,
            ?string $newFromAddress = null,
            ?string $newToAddress = null,
            ?string $newDate = null
    ): string {
        $additionalConditions = '';
        if (!empty($deal[botManager::ADDITIONAL_CONDITIONS_FIELD])) {
            $additionalConditions = implode(" | ", $deal[botManager::ADDITIONAL_CONDITIONS_FIELD]);
        }
        $dateText = $deal[botManager::TRAVEL_DATE_TIME_FIELD];
        if ($newDate !== null) {
            $dateText = "<s>{$deal[botManager::TRAVEL_DATE_TIME_FIELD_SERVICE]}</s> ‚ûî {$newDate}";
        }



        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        $fromAddress = $deal[botManager::ADDRESS_FROM_FIELD];
        if ($newFromAddress !== null) {
            $fromAddress = "<s>{$deal[botManager::ADDRESS_FROM_FIELD_SERVICE]}</s> ‚ûî {$newFromAddress}";
        }



        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        $toAddress = $deal[botManager::ADDRESS_TO_FIELD];
        if ($newToAddress !== null) {
            $toAddress = "<s>{$deal[botManager::ADDRESS_TO_FIELD_SERVICE]}</s> ‚ûî {$newToAddress}";
        }



        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—É–º–º—É
        $sumText = $deal[botManager::DRIVER_SUM_FIELD];
        if ($newSum !== null) {
            $sumText = "<s>{$deal[botManager::DRIVER_SUM_FIELD_SERVICE]}</s> ‚ûî {$newSum}|RUB";
        }

        $header = $deal['ID'];
        if($newSum || $newToAddress || $newFromAddress || $newDate) {
            $header = "–ó–∞—è–≤–∫–∞ {$deal['ID']} –∏–∑–º–µ–Ω–µ–Ω–∞:";
        }


        $text = <<<HTML
#Ô∏è‚É£ $header

üìÜ {$dateText}

üÖ∞Ô∏è {$fromAddress}

üÖ±Ô∏è {$toAddress}

‚ÑπÔ∏è {$additionalConditions}

üí∞ {$sumText}
HTML;

        return $text;
    }

    public static function writeToLog($LogFileName, $info, $prefix, $wa) {
        require_once(__DIR__ . '/../crest/crest.php');
        
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if (empty($deal['ID'])) {
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–¥–µ–ª–∫–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ "–í–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª"
        if ($deal['STAGE_ID'] !== botManager::DRIVER_ACCEPTED_STAGE_ID) {
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å
        if (!empty($deal[botManager::REMINDER_SENT_FIELD])) {
            return false;
        }
        
        $driver = \CRest::call('crm.contact.get', [
            'id' => $deal[botManager::DRIVER_ID_FIELD],
            'select' => [botManager::DRIVER_TELEGRAM_ID_FIELD]
        ])['result'];
        
        if (empty($driver) || empty($driver[botManager::DRIVER_TELEGRAM_ID_FIELD])) {
            return false;
        }
        
        $driverTelegramId = (int) $driver[botManager::DRIVER_TELEGRAM_ID_FIELD];
        
        $keyboard = new Keyboard();
        $keyboard->inline();
        $keyboard->row([
            Keyboard::inlineButton(['text' => '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é', 'callback_data' => "confirm_$dealId"]),
        ]);
        
        $message = $telegram->sendMessage([
            'chat_id' => $driverTelegramId,
            'text' => "‚ö†Ô∏è –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï!\n\n–ß–µ—Ä–µ–∑ 1 —á–∞—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ–µ–∑–¥–∫–∞ –ø–æ –∑–∞—è–≤–∫–µ #{$dealId}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞.",
            'reply_markup' => $keyboard,
        ]);
        
        if ($message) {
            // –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
            \CRest::call('crm.deal.update', [
                'id' => $dealId,
                'fields' => [botManager::REMINDER_SENT_FIELD => date('Y-m-d H:i:s')]
            ]);
            return true;
        }
        
        return false;
    }
    
    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø–æ–µ–∑–¥–∫–µ
     */
    public static function confirmReminderHandle(int $dealId, Api $telegram, Update $result): void {
        require_once(__DIR__ . '/../crest/crest.php');
        
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if (empty($deal['ID'])) {
            $telegram->answerCallbackQuery([
                'callback_query_id' => $result->callbackQuery->id,
                'text' => '–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞',
                'show_alert' => true
            ]);
            return;
        }
        
        $message = $result->getCallbackQuery()->getMessage();
        $chatId = $message->getChat()->getId();
        
        // –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
        \CRest::call('crm.deal.update', [
            'id' => $dealId,
            'fields' => [botManager::REMINDER_CONFIRMED_FIELD => date('Y-m-d H:i:s')]
        ]);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        $telegram->editMessageText([
            'chat_id' => $chatId,
            'message_id' => $message->getMessageId(),
            'text' => "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!\n\n–ó–∞—è–≤–∫–∞ #{$dealId} - –≤–æ–¥–∏—Ç–µ–ª—å –≥–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞.",
        ]);
        
        $telegram->answerCallbackQuery([
            'callback_query_id' => $result->callbackQuery->id,
            'text' => '–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!',
            'show_alert' => false
        ]);
    }
    
    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É –ª–∏—Ü—É –æ —Ç–æ–º, —á—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞–∫–∞–∑
     */
    public static function sendResponsibleNotification(int $dealId, Api $telegram): bool {
        require_once(__DIR__ . '/../crest/crest.php');
        
        $deal = \CRest::call('crm.deal.get', ['id' => $dealId])['result'];
        if (empty($deal['ID'])) {
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å
        if (!empty($deal[botManager::REMINDER_NOTIFICATION_SENT_FIELD])) {
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –Ω–æ –≤–æ–¥–∏—Ç–µ–ª—å –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª
        if (empty($deal[botManager::REMINDER_SENT_FIELD]) || !empty($deal[botManager::REMINDER_CONFIRMED_FIELD])) {
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ 15 –º–∏–Ω—É—Ç —Å –º–æ–º–µ–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        $reminderTime = strtotime($deal[botManager::REMINDER_SENT_FIELD]);
        $currentTime = time();
        
        if (($currentTime - $reminderTime) < 900) { // 900 —Å–µ–∫—É–Ω–¥ = 15 –º–∏–Ω—É—Ç
            return false;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É –ª–∏—Ü—É
        $notify = \CRest::call('im.notify.system.add', [
            'USER_ID' => $deal['ASSIGNED_BY_ID'],
            'MESSAGE' => "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –í–æ–¥–∏—Ç–µ–ª—å 15 –º–∏–Ω—É—Ç –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞–∫–∞–∑ #{$dealId}. " .
                        "<a href='https://b24-cprnr5.bitrix24.ru/crm/deal/details/{$dealId}/'>{$deal['TITLE']}</a>"
        ]);
        
        if ($notify) {
            // –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
            \CRest::call('crm.deal.update', [
                'id' => $dealId,
                'fields' => [botManager::REMINDER_NOTIFICATION_SENT_FIELD => date('Y-m-d H:i:s')]
            ]);
            return true;
        }
        
        return false;
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
     */
    public static function checkAndSendReminders(Api $telegram): array {
        require_once(__DIR__ . '/../crest/crest.php');
        
        $result = [
            'reminders_sent' => 0,
            'notifications_sent' => 0,
            'errors' => []
        ];
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ "–í–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª"
        $deals = \CRest::call('crm.deal.list', [
            'filter' => [
                'STAGE_ID' => botManager::DRIVER_ACCEPTED_STAGE_ID,
                '!'.botManager::REMINDER_SENT_FIELD => false
            ],
            'select' => ['ID', botManager::TRAVEL_DATE_TIME_FIELD, botManager::REMINDER_SENT_FIELD]
        ])['result'];
        
        foreach ($deals as $deal) {
            try {
                $travelTime = strtotime($deal[botManager::TRAVEL_DATE_TIME_FIELD]);
                $currentTime = time();
                $timeUntilTravel = $travelTime - $currentTime;
                
                // –ï—Å–ª–∏ –¥–æ –ø–æ–µ–∑–¥–∫–∏ –æ—Å—Ç–∞–ª—Å—è 1 —á–∞—Å (3600 —Å–µ–∫—É–Ω–¥) –∏–ª–∏ –º–µ–Ω—å—à–µ
                if ($timeUntilTravel <= 3600 && $timeUntilTravel > 0) {
                    if (botManager::sendTravelReminder($deal['ID'], $telegram)) {
                        $result['reminders_sent']++;
                    } else {
                        $result['errors'][] = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –∑–∞—è–≤–∫–∏ #{$deal['ID']}";
                    }
                }
            } catch (Exception $e) {
                $result['errors'][] = "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏ #{$deal['ID']}: " . $e->getMessage();
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞—è–≤–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É
        $dealsForNotification = \CRest::call('crm.deal.list', [
            'filter' => [
                'STAGE_ID' => botManager::DRIVER_ACCEPTED_STAGE_ID,
                '!'.botManager::REMINDER_SENT_FIELD => false,
                '!'.botManager::REMINDER_CONFIRMED_FIELD => false,
                '!'.botManager::REMINDER_NOTIFICATION_SENT_FIELD => false
            ],
            'select' => ['ID', botManager::REMINDER_SENT_FIELD]
        ])['result'];
        
        foreach ($dealsForNotification as $deal) {
            try {
                if (botManager::sendResponsibleNotification($deal['ID'], $telegram)) {
                    $result['notifications_sent']++;
                } else {
                    $result['errors'][] = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É –¥–ª—è –∑–∞—è–≤–∫–∏ #{$deal['ID']}";
                }
            } catch (Exception $e) {
                $result['errors'][] = "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∑–∞—è–≤–∫–∏ #{$deal['ID']}: " . $e->getMessage();
            }
        }
        
        return $result;
    }

    public static function writeToLog($LogFileName, $data, $title = '', $wa)
    {
        if($LogFileName === "")
        {
            return false;
        }

        $parsedPath = explode("/", $LogFileName);
        $newPath = substr($LogFileName, 0, strlen($LogFileName) - strlen($parsedPath[count($parsedPath) - 1]));

        if($parsedPath[count($parsedPath) - 2] !== "logs"  && !file_exists(getcwd() . $newPath))
        {
            mkdir(getcwd() . $newPath);
        }

        $LogFileName .= ".php";
        $log = "";

        if(!file_exists(getcwd() . $LogFileName))
        {
            $log = "<?php /*";
        }

        $log .= "\n------------------------\n";
        $log .= date("Y.m.d G:i:s") . "\n";
        $log .= (strlen($title) > 0 ? $title : 'DEBUG') . "\n";
        $log .= print_r($data, 1);
        $log .= "\n------------------------\n";

        //		file_put_contents(getcwd() . '/hook.log', $log, FILE_APPEND);
        if ($wa == 'w')
        {
            file_put_contents(getcwd() . $LogFileName, $log);
        }
        else
        {
            file_put_contents(getcwd() . $LogFileName, $log, FILE_APPEND);
        }

        return true;
    }
}