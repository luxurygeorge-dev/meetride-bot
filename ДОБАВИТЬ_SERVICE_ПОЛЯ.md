# üìã –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å SERVICE –ø–æ–ª—è –≤ Bitrix24

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ –∏ –ø–∞—Å—Å–∞–∂–∏—Ä—ã –ù–ï –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –í Bitrix24 –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç SERVICE –ø–æ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π

---

## ‚úÖ –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨

### –î–æ–±–∞–≤–∏—Ç—å 2 –Ω–æ–≤—ã—Ö –ø–æ–ª—è –≤ Bitrix24:

#### 1. SERVICE –ø–æ–ª–µ –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
- **–û–±—ä–µ–∫—Ç:** –°–¥–µ–ª–∫–∞ (Deal)
- **–¢–∏–ø –ø–æ–ª—è:** –°—Ç—Ä–æ–∫–∞ (String)
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** `–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (—Å–ª—É–∂.)`
- **–°–∏–º–≤–æ–ª—å–Ω—ã–π –∫–æ–¥:** `UF_CRM_XXXXX` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- **–î–æ—Å—Ç—É–ø:** –°–∫—Ä—ã—Ç–æ–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è API)

#### 2. SERVICE –ø–æ–ª–µ –¥–ª—è –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
- **–û–±—ä–µ–∫—Ç:** –°–¥–µ–ª–∫–∞ (Deal)
- **–¢–∏–ø –ø–æ–ª—è:** –°—Ç—Ä–æ–∫–∞ (String) –∏–ª–∏ –°–ø–∏—Å–æ–∫ (List)
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** `–ü–∞—Å—Å–∞–∂–∏—Ä—ã (—Å–ª—É–∂.)`
- **–°–∏–º–≤–æ–ª—å–Ω—ã–π –∫–æ–¥:** `UF_CRM_XXXXX` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- **–î–æ—Å—Ç—É–ø:** –°–∫—Ä—ã—Ç–æ–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è API)

---

## üîß –ì–î–ï –°–û–ó–î–ê–¢–¨ –ü–û–õ–Ø

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

1. –û—Ç–∫—Ä–æ–π—Ç–µ Bitrix24: https://meetride.bitrix24.ru/
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí CRM ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ‚Üí –°–¥–µ–ª–∫–∏**
3. –ù–∞–∂–º–∏—Ç–µ **"–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ"**
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - –ù–∞–∑–≤–∞–Ω–∏–µ: `–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (—Å–ª—É–∂.)`
   - –¢–∏–ø: –°—Ç—Ä–æ–∫–∞
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ: –ù–µ—Ç
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ
6. **–í–ê–ñ–ù–û:** –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä `UF_CRM_1234567890`)
7. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–ª—è –ø–æ–ª—è "–ü–∞—Å—Å–∞–∂–∏—Ä—ã (—Å–ª—É–∂.)"

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ REST API

```bash
# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ SERVICE
curl -X POST "https://meetride.bitrix24.ru/rest/9/oo1pdplpuoy0q9ur/crm.deal.userfield.add.json" \
  -d "fields[FIELD_NAME]=UF_CRM_INTERMEDIATE_SERVICE" \
  -d "fields[USER_TYPE_ID]=string" \
  -d "fields[EDIT_FORM_LABEL]=–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (—Å–ª—É–∂.)" \
  -d "fields[LIST_COLUMN_LABEL]=–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (—Å–ª—É–∂.)"

# –ü–∞—Å—Å–∞–∂–∏—Ä—ã SERVICE
curl -X POST "https://meetride.bitrix24.ru/rest/9/oo1pdplpuoy0q9ur/crm.deal.userfield.add.json" \
  -d "fields[FIELD_NAME]=UF_CRM_PASSENGERS_SERVICE" \
  -d "fields[USER_TYPE_ID]=string" \
  -d "fields[EDIT_FORM_LABEL]=–ü–∞—Å—Å–∞–∂–∏—Ä—ã (—Å–ª—É–∂.)" \
  -d "fields[LIST_COLUMN_LABEL]=–ü–∞—Å—Å–∞–∂–∏—Ä—ã (—Å–ª—É–∂.)"
```

---

## üìù –ü–û–°–õ–ï –°–û–ó–î–ê–ù–ò–Ø –ü–û–õ–ï–ô

### 1. –£–∑–Ω–∞–π—Ç–µ ID —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π

```bash
cd /root/meetride
php -r "
require_once('/home/telegramBot/crest/crest.php');
\$fields = CRest::call('crm.deal.fields')['result'];
foreach (\$fields as \$key => \$field) {
    if (strpos(\$field['formLabel'], '—Å–ª—É–∂') !== false) {
        echo \$key . ' = ' . \$field['formLabel'] . \"\n\";
    }
}
"
```

### 2. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ botManager.php

–û—Ç–∫—Ä–æ–π—Ç–µ `/root/meetride/botManager.php` –∏ –¥–æ–±–∞–≤—å—Ç–µ:

```php
// –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 33 –¥–æ–±–∞–≤–∏—Ç—å:
public const INTERMEDIATE_POINTS_FIELD_SERVICE = 'UF_CRM_XXXXXXXXX'; // ID –∏–∑ –ø.1
public const PASSENGERS_FIELD = 'UF_CRM_1751271798896'; // –£–∂–µ –µ—Å—Ç—å
public const PASSENGERS_FIELD_SERVICE = 'UF_CRM_YYYYYYYYY'; // ID –∏–∑ –ø.1
```

### 3. –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é dealChangeHandle()

–í —Ñ–∞–π–ª–µ `/root/meetride/botManager.php` –Ω–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ 1149-1153:

```php
// 4. –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
// TODO: –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ SERVICE –ø–æ–ª–µ –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫ –≤ Bitrix24

// 5. –ü–∞—Å—Å–∞–∂–∏—Ä—ã
// TODO: –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ SERVICE –ø–æ–ª–µ –¥–ª—è –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –≤ Bitrix24
```

–ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞:

```php
// 4. –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
$serviceIntermediate = $deal[botManager::INTERMEDIATE_POINTS_FIELD_SERVICE] ?? '';
$currentIntermediate = $deal[botManager::INTERMEDIATE_POINTS_FIELD] ?? '';

if ($serviceIntermediate && $serviceIntermediate != $currentIntermediate) {
    $changes[] = [
        'field' => 'intermediatePoints',
        'emoji' => 'üó∫Ô∏è',
        'label' => '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏',
        'old' => $serviceIntermediate ?: '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        'new' => $currentIntermediate ?: '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
    ];
    $updateServiceFields[botManager::INTERMEDIATE_POINTS_FIELD_SERVICE] = $currentIntermediate;
}

// 5. –ü–∞—Å—Å–∞–∂–∏—Ä—ã
$servicePassengers = $deal[botManager::PASSENGERS_FIELD_SERVICE] ?? '';
$currentPassengers = $deal[botManager::PASSENGERS_FIELD] ?? '';

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–æ–≤
if (is_array($currentPassengers)) {
    $currentPassengers = implode(", ", $currentPassengers);
}
if (is_array($servicePassengers)) {
    $servicePassengers = implode(", ", $servicePassengers);
}

if ($servicePassengers && $servicePassengers != $currentPassengers) {
    $changes[] = [
        'field' => 'passengers',
        'emoji' => 'üë•',
        'label' => '–ü–∞—Å—Å–∞–∂–∏—Ä—ã',
        'old' => $servicePassengers ?: '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        'new' => $currentPassengers ?: '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
    ];
    $updateServiceFields[botManager::PASSENGERS_FIELD_SERVICE] = $currentPassengers;
}
```

### 4. –û–±–Ω–æ–≤–∏—Ç–µ select –≤ dealChangeHandle()

–í —Å—Ç—Ä–æ–∫–µ 1041-1048 –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –ø–æ–ª—è:

```php
$deal = \CRest::call('crm.deal.get', [
    'id' => $dealId,
    'select' => [
        '*',
        'UF_CRM_1751271798896', // –ü–∞—Å—Å–∞–∂–∏—Ä—ã
        botManager::INTERMEDIATE_POINTS_FIELD, // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
        botManager::ADDRESS_FROM_FIELD_SERVICE, // SERVICE: –û—Ç–∫—É–¥–∞
        botManager::ADDRESS_TO_FIELD_SERVICE, // SERVICE: –ö—É–¥–∞
        botManager::TRAVEL_DATE_TIME_FIELD_SERVICE, // SERVICE: –í—Ä–µ–º—è
        botManager::INTERMEDIATE_POINTS_FIELD_SERVICE, // SERVICE: –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ - –î–û–ë–ê–í–ò–¢–¨
        botManager::PASSENGERS_FIELD_SERVICE, // SERVICE: –ü–∞—Å—Å–∞–∂–∏—Ä—ã - –î–û–ë–ê–í–ò–¢–¨
    ]
])['result'];
```

### 5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω

```bash
cd /root/meetride
php -l botManager.php  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
cp botManager.php /var/www/html/meetRiedeBot/botManager.php
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π:

1. –ò–∑–º–µ–Ω–∏—Ç–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ –≤ –∑–∞—è–≤–∫–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
tail -f /var/www/html/meetRiedeBot/logs/webhook_debug.log
```

3. –î–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
```
üó∫Ô∏è –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏: <s>–¢–æ—á–∫–∞ 1</s> ‚ûî –¢–æ—á–∫–∞ 2
```

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê

| –ü–æ–ª–µ | –û—Å–Ω–æ–≤–Ω–æ–µ | SERVICE | –°—Ç–∞—Ç—É—Å |
|------|----------|---------|--------|
| –û—Ç–∫—É–¥–∞ | UF_CRM_1751269147414 | UF_CRM_1751638512 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| –ö—É–¥–∞ | UF_CRM_1751269175432 | UF_CRM_1751638529 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| –í—Ä–µ–º—è | UF_CRM_1751269222959 | UF_CRM_1751638617 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ | UF_CRM_1754228146 | **–°–æ–∑–¥–∞—Ç—å** | ‚ö†Ô∏è TODO |
| –ü–∞—Å—Å–∞–∂–∏—Ä—ã | UF_CRM_1751271798896 | **–°–æ–∑–¥–∞—Ç—å** | ‚ö†Ô∏è TODO |

---

## ‚ùì –ù–£–ñ–ù–ê –ü–û–ú–û–©–¨?

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ø–æ–ª–µ–π - –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å!

–Ø –º–æ–≥—É:
1. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—è —á–µ—Ä–µ–∑ REST API
2. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø–æ–ª–µ–π
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É

---

**–ë–µ–∑ SERVICE –ø–æ–ª–µ–π –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ –∏ –ø–∞—Å—Å–∞–∂–∏—Ä—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å—Å—è –ù–ï –ë–£–î–£–¢!**


