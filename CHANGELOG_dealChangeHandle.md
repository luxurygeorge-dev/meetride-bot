# Changelog: –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

## –î–∞—Ç–∞: 2025-10-05

## –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ "–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏"
**–§–∞–π–ª:** `botManager.php` (—Å—Ç—Ä–æ–∫–∞ 25)

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—è "–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏":
```php
public const INTERMEDIATE_POINTS_FIELD = 'UF_CRM_1751822573510'; // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
```

### 2. –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `dealChangeHandle()`
**–§–∞–π–ª:** `botManager.php` (—Å—Ç—Ä–æ–∫–∏ 913-1136)

#### –ß—Ç–æ –±—ã–ª–æ (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è):
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ SERVICE –ø–æ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –°–ª–æ–∂–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è SERVICE –ø–æ–ª–µ–π (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–∞—Ç—ã, "Array", –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–ª–∞ 8+ –ø–æ–ª–µ–π (–≤–∫–ª—é—á–∞—è —Å—É–º–º—É, –Ω–æ–º–µ—Ä —Ä–µ–π—Å–∞, –∫–ª–∞—Å—Å –∞–≤—Ç–æ, –¥–æ–ø. —É—Å–ª–æ–≤–∏—è)
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É (30 —Å–µ–∫—É–Ω–¥)
- –û–±–Ω–æ–≤–ª—è–ª–∞ SERVICE –ø–æ–ª—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### –ß—Ç–æ —Å—Ç–∞–ª–æ (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è):
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç OLD –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ webhook** (`$_REQUEST['data']['FIELDS']['OLD']`)
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ 5 –ø–æ–ª–µ–π –ø–æ –¢–ó:**
  1. –¢–æ—á–∫–∞ –ê (–æ—Ç–∫—É–¥–∞)
  2. –¢–æ—á–∫–∞ –ë (–∫—É–¥–∞)
  3. –í—Ä–µ–º—è –ø–æ–µ–∑–¥–∫–∏
  4. –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
  5. –ü–∞—Å—Å–∞–∂–∏—Ä—ã
- –£–≤–µ–¥–æ–º–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç–∞–¥–∏—è—Ö `PREPAYMENT_INVOICE` –∏ `EXECUTING`
- –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É –≤ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π –≤–∏–¥ (d.m.Y H:i)
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `/var/www/html/meetRiedeBot/logs/webhook_debug.log`
- **–£–±—Ä–∞–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞** - —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
- **–ù–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç SERVICE –ø–æ–ª—è** - –æ–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã

#### –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:
```
üöó –ó–∞—è–≤–∫–∞ #777 –∏–∑–º–µ–Ω–µ–Ω–∞:

üÖ∞Ô∏è –û—Ç–∫—É–¥–∞: <s>—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</s> ‚ûî –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

üÖ±Ô∏è –ö—É–¥–∞: <s>—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</s> ‚ûî –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω webhook handler
**–§–∞–π–ª:** `src/index.php` (—Å—Ç—Ä–æ–∫–∏ 88-92, 103-107)

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ OLD –∑–Ω–∞—á–µ–Ω–∏–π –≤ `dealChangeHandle()`:
```php
// –ü–æ–ª—É—á–∞–µ–º OLD –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ webhook
$oldValues = $_REQUEST['data']['FIELDS']['OLD'] ?? null;

// –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π
botManager::dealChangeHandle($dealId, $telegram, $update, $oldValues);
```

## –ü–æ—á–µ–º—É —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã:
1. **SERVICE –ø–æ–ª—è —Å–æ–¥–µ—Ä–∂–∞–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (–¥–∞—Ç—ã –≤–º–µ—Å—Ç–æ –∞–¥—Ä–µ—Å–æ–≤, "Array" –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
2. **–õ–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ
3. **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω—ã
4. **–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏** - –≤–∞–ª–∏–¥–∞—Ü–∏—è SERVICE –ø–æ–ª–µ–π, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:
1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–µ OLD –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ Bitrix24
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –Ω–µ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
3. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–ó** - —Ç–æ–ª—å–∫–æ 5 –Ω—É–∂–Ω—ã—Ö –ø–æ–ª–µ–π
4. **–õ–µ–≥–∫–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏** - –Ω–µ—Ç SERVICE –ø–æ–ª–µ–π, –Ω–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ:
- ‚úÖ Bitrix24 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç OLD –∑–Ω–∞—á–µ–Ω–∏—è –≤ `$_REQUEST['data']['FIELDS']['OLD']`
- ‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è
- ‚úÖ –§—É–Ω–∫—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç OLD –∑–Ω–∞—á–µ–Ω–∏—è

### –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ production:
1. –ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É –ê –≤ –∑–∞—è–≤–∫–µ —Å–æ —Å—Ç–∞–¥–∏–µ–π PREPAYMENT_INVOICE
2. –ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É –ë –≤ –∑–∞—è–≤–∫–µ —Å–æ —Å—Ç–∞–¥–∏–µ–π EXECUTING
3. –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –ø–æ–µ–∑–¥–∫–∏
4. –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
5. –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤
6. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–º —Å—Ç–∞—Ä—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ó–∞–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `dealChangeHandle()` –≤ `botManager.php`
2. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `src/index.php` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ OLD –∑–Ω–∞—á–µ–Ω–∏–π
3. ‚è≥ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ production —Å–µ—Ä–≤–µ—Ä
4. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–π –∑–∞—è–≤–∫–µ
5. ‚è≥ –£–¥–∞–ª–∏—Ç—å SERVICE –ø–æ–ª—è –∏–∑ Bitrix24 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)

## –†–∏—Å–∫–∏ –∏ –º–µ—Ä—ã –ø—Ä–µ–¥–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏:
- –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–µ–Ω–∞
- –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–º–µ–µ—Ç fallback –Ω–∞ `$_REQUEST` –µ—Å–ª–∏ OLD –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è: `/var/www/html/meetRiedeBot/logs/webhook_debug.log`
- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö - –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ –∏–∑ git

## –§–∞–π–ª—ã –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ production

1. `/root/meetride/botManager.php` ‚Üí `/var/www/html/meetRiedeBot/botManager.php`
2. `/root/meetride/src/index.php` ‚Üí `/var/www/html/meetRiedeBot/index.php`

## –ê–≤—Ç–æ—Ä
Claude Code

## –ó–∞–º–µ—Ç–∫–∏
- SERVICE –ø–æ–ª—è –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ git
- –ù–æ–≤—ã–π —Ñ–∞–π–ª `new_dealChangeHandle.php` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏
