# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

**–î–∞—Ç–∞:** 08.10.2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±—â–∏–π —á–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

## ‚ùå –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

**Cron –∑–∞–¥–∞–Ω–∏–µ** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (`* * * * *`):
```
* * * * * /usr/bin/php /var/www/html/meetRiedeBot/check_preparation_deals_new.php
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
1. –ü–æ–ª—É—á–∞–µ—Ç –í–°–ï –∑–∞—è–≤–∫–∏ –≤ —Å—Ç–∞–¥–∏–∏ `PREPARATION`
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ –æ–±—â–∏–π —á–∞—Ç
3. **–ù–ï –ø—Ä–æ–≤–µ—Ä—è–ª** –±—ã–ª–∏ –ª–∏ –æ–Ω–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∞—Å—å –∑–∞–Ω–æ–≤–æ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É, –ø–æ–∫–∞ –æ–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞–¥–∏–∏ PREPARATION.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–ª—É–∂–µ–±–Ω–æ–µ –ø–æ–ª–µ –≤ Bitrix24

**–ü–æ–ª–µ:** `UF_CRM_1759918565` - "–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—â–∏–π —á–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"  
**–¢–∏–ø:** –°—Ç—Ä–æ–∫–∞  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –¥–∞—Ç—É/–≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±—â–∏–π —á–∞—Ç

### 2. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

#### A) –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –≤ `botManager.php`:
```php
public const GROUP_MESSAGE_SENT_FIELD = 'UF_CRM_1759918565';
```

#### B) –§—É–Ω–∫—Ü–∏—è `newDealMessage()` —Ç–µ–ø–µ—Ä—å –ø–æ–º–µ—á–∞–µ—Ç –∑–∞—è–≤–∫—É:
```php
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
if ($success) {
    \CRest::call('crm.deal.update', [
        'id' => $dealid,
        'fields' => [
            botManager::GROUP_MESSAGE_SENT_FIELD => date('Y-m-d H:i:s')
        ]
    ]);
}
```

#### C) –°–∫—Ä–∏–ø—Ç `check_preparation_deals_new.php` —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ:
```php
// –§–∏–ª—å—Ç—Ä—É–µ–º - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
foreach ($allDeals as $deal) {
    $sent = $deal[botManager::GROUP_MESSAGE_SENT_FIELD] ?? '';
    if (empty($sent)) {
        $deals[] = $deal; // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
    } else {
        echo "–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞—è–≤–∫—É #{$deal['ID']} - —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞\n";
    }
}
```

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå –ó–∞—è–≤–∫–∞ #857 –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∞—Å—å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚ùå –°–ø–∞–º –≤ –æ–±—â–µ–º —á–∞—Ç–µ
- ‚ùå Telegram –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ ("Too Many Requests")

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **–û–î–ò–ù –†–ê–ó** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫ **–ù–ï–¢**
- ‚úÖ Cron —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üìä –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏:

1. **–ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç** –∑–∞—è–≤–∫—É –≤ Bitrix24 –≤ —Å—Ç–∞–¥–∏–∏ `PREPARATION`
2. **–ü–æ–ª–µ GROUP_MESSAGE_SENT_FIELD** = –ø—É—Å—Ç–æ–µ
3. **Cron –Ω–∞—Ö–æ–¥–∏—Ç** –∑–∞—è–≤–∫—É (—á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É –º–∞–∫—Å–∏–º—É–º)
4. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª–µ** - –ø—É—Å—Ç–æ? ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
5. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç** —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—â–∏–π —á–∞—Ç
6. **–ü–æ–º–µ—á–∞–µ—Ç –ø–æ–ª–µ** = —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞/–≤—Ä–µ–º—è
7. **–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ cron** - –≤–∏–¥–∏—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –ø–æ–ª–µ ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç

### –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ:
```
–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫ –≤ PREPARATION: 1
–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞—è–≤–∫—É #857 - —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ (2025-10-08 13:18:14)
–ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ—Ç
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –º–æ–∂–Ω–æ —Ç–∞–∫:

1. **–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É** —á–µ—Ä–µ–∑ –±–æ—Ç
2. **–î–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–ø—Ä–∞–≤–∫–∏** –≤ –æ–±—â–∏–π —á–∞—Ç (–º–∞–∫—Å–∏–º—É–º 1 –º–∏–Ω—É—Ç–∞)
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Bitrix24** –ø–æ–ª–µ "–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—â–∏–π —á–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–∞—Ç–∞
4. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç** - —Å–æ–æ–±—â–µ–Ω–∏–µ –ù–ï –¥–æ–ª–∂–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cron –≤—Ä—É—á–Ω—É—é:
```bash
cd /var/www/html/meetRiedeBot && php check_preparation_deals_new.php
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** "–ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ—Ç"

---

## üõ†Ô∏è –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∑–∞—è–≤–∫—É –≤ Bitrix24
2. –û—á–∏—Å—Ç–∏—Ç–µ –ø–æ–ª–µ "–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—â–∏–π —á–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
3. –î–æ–∂–¥–∏—Ç–µ—Å—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞ cron (–¥–æ 1 –º–∏–Ω—É—Ç—ã)

### –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
tail -f /var/www/html/meetRiedeBot/logs/webhook_debug.log
```

---

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`/var/www/html/meetRiedeBot/botManager.php`**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `GROUP_MESSAGE_SENT_FIELD`
   - –ò–∑–º–µ–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `newDealMessage()` - –ø–æ–º–µ—Ç–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

2. **`/var/www/html/meetRiedeBot/check_preparation_deals_new.php`**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫

3. **`/root/meetride/botManager.php`**
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º

4. **`/var/www/html/meetRiedeBot/fix_existing_preparation_deals.php`**
   - –°–æ–∑–¥–∞–Ω –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞—è–≤–æ–∫

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!

–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞—è–≤–∫–∞ –Ω–∞–ø—Ä—è–º—É—é –≤ Bitrix24 (–Ω–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞), cron –≤—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç –µ–µ –≤ —á–∞—Ç –æ–¥–∏–Ω —Ä–∞–∑.




