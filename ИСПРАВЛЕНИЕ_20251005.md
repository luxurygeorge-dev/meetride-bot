# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Fatal Error –≤ MeetRide Bot
**–î–∞—Ç–∞:** 5 –æ–∫—Ç—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º:** "–ù–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" ‚Äî –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–ª –Ω–∞ webhook'–∏ –æ—Ç Bitrix24 –∏ Telegram

**–ü—Ä–∏—á–∏–Ω–∞:** Fatal Error –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∞—Å—Å–∞ `Store\botManager`
```
PHP Fatal error: Cannot redefine class constant Store\botManager::INTERMEDIATE_POINTS_FIELD
```

### –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∫–ª–∞—Å—Å–∞:**
   - `/var/www/html/meetRiedeBot/botManager.php` (–∫–æ—Ä–Ω–µ–≤–æ–π)
   - `/var/www/html/meetRiedeBot/src/botManager.php`
   - `/var/www/html/meetRiedeBot/Store/botManager.php`

2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç:**
   –í –∫–æ—Ä–Ω–µ–≤–æ–º `botManager.php` –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `INTERMEDIATE_POINTS_FIELD` –±—ã–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ **–î–í–ê–ñ–î–´**:
   - –°—Ç—Ä–æ–∫–∞ 23: `'UF_CRM_1751822573510'`
   - –°—Ç—Ä–æ–∫–∞ 37: `'UF_CRM_1751854228146'`

3. **Composer autoload:**
   PSR-4 –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫ –ø—ã—Ç–∞–ª—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∞—Å—Å –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, —á—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ —Ñ–∞—Ç–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É.

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### 1. –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø
```bash
/root/meetride_backup_20251005_XXXXXX/
```

### 2. –£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –∫–ª–∞—Å—Å–∞
**–ü—Ä–æ–¥–∞–∫—à–Ω (`/var/www/html/meetRiedeBot/`):**
- ‚ùå –£–¥–∞–ª–µ–Ω–æ: `Store/botManager.php`
- ‚ùå –£–¥–∞–ª–µ–Ω–æ: `src/botManager.php`
- ‚úÖ –û—Å—Ç–∞–≤–ª–µ–Ω–æ: `botManager.php` (–∫–æ—Ä–Ω–µ–≤–æ–π, –æ–±–Ω–æ–≤–ª–µ–Ω)

**–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (`/root/meetride/`):**
- ‚ùå –£–¥–∞–ª–µ–Ω–æ: `src/botManager.php`
- ‚ùå –£–¥–∞–ª–µ–Ω–æ: `meetride-bot/botManager.php`
- ‚ùå –£–¥–∞–ª–µ–Ω–æ: `meetride-bot/src/botManager.php`
- ‚úÖ –û—Å—Ç–∞–≤–ª–µ–Ω–æ: `botManager.php` (–∫–æ—Ä–Ω–µ–≤–æ–π)

### 3. –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—É—Ç–∏ –≤ entry point'–∞—Ö

**`/var/www/html/meetRiedeBot/src/index.php`:**
```php
// –ë—ã–ª–æ:
require_once(__DIR__ . '/botManager.php');

// –°—Ç–∞–ª–æ:
require_once(__DIR__ . '/../botManager.php');
```

### 4. –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω autoload
```bash
composer dump-autoload -o
```

---

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

‚úÖ **PHP Syntax:** No errors detected
‚úÖ **Class Autoload:** OK
‚úÖ **Webhook endpoints:** No syntax errors
‚úÖ **Composer autoload:** No duplicate class warnings

---

## üéØ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. Bitrix24 Webhook ‚Üí Bot
```
Bitrix24 ‚Üí ONCRMDEALUPDATE
         ‚Üí https://skysoft24.ru/meetRiedeBot/src/index.php
         ‚Üí botManager::newDealMessage() / dealChangeHandle()
         ‚Üí –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram –≥—Ä—É–ø–ø—É
```

### 2. Telegram Callback ‚Üí Bot
```
Telegram ‚Üí Callback Query (–Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏)
        ‚Üí https://skysoft24.ru/meetRiedeBot/webhook.php
        ‚Üí botManager::buttonHanlde()
        ‚Üí –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –≤–æ–¥–∏—Ç–µ–ª—è
```

### 3. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```
Bitrix24 –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
        ‚Üí dealChangeHandle()
        ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ SERVICE –ø–æ–ª–µ–π
        ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—é
```

---

## üìã –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã (–∫–∞–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ)

### –¶–∏–∫–ª —Ä–∞–±–æ—Ç—ã –∑–∞—è–≤–∫–∏:

1. **NEW ‚Üí PREPARATION** (–ú–µ–Ω–µ–¥–∂–µ—Ä —Å—Ç–∞–≤–∏—Ç "–ü–æ–∏—Å–∫ –≤–æ–¥–∏—Ç–µ–ª—è")
   - Webhook –æ—Ç Bitrix24
   - –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –≥—Ä—É–ø–ø—É "–ó–∞—è–≤–∫–∏ MeetRide" —Å –∫–Ω–æ–ø–∫–∞–º–∏ [–ü—Ä–∏–Ω—è—Ç—å] [–û—Ç–∫–∞–∑–∞—Ç—å—Å—è]

2. **–í–æ–¥–∏—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–∏–Ω—è—Ç—å"**
   - Telegram Callback Query
   - `buttonHanlde()` ‚Üí `driverAcceptHandle()`
   - –°–º–µ–Ω–∞ —Å—Ç–∞–¥–∏–∏: **PREPARATION ‚Üí PREPAYMENT_INVOICE**
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É: "‚úÖ –í–æ–¥–∏—Ç–µ–ª—å [–ò–º—è] –ø—Ä–∏–Ω—è–ª –∑–∞—è–≤–∫—É"
   - –î–µ—Ç–∞–ª–∏ –≤ –õ–° –≤–æ–¥–∏—Ç–µ–ª—é

3. **PREPAYMENT_INVOICE / EXECUTING** (–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π)
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ 5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π:
     * –¢–æ—á–∫–∞ –ê (–æ—Ç–∫—É–¥–∞)
     * –¢–æ—á–∫–∞ –ë (–∫—É–¥–∞)
     * –í—Ä–µ–º—è –ø–æ–µ–∑–¥–∫–∏
     * –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
     * –ü–∞—Å—Å–∞–∂–∏—Ä—ã
   - –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—é –≤ –õ–°

4. **EXECUTING ‚Üí FINAL_INVOICE** (–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
   - –í–æ–¥–∏—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ó–∞—è–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã:**
   –¢–µ–ø–µ—Ä—å –∫–ª–∞—Å—Å `botManager` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ:
   - `/var/www/html/meetRiedeBot/botManager.php`
   - `/root/meetride/botManager.php`

2. **–ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã:**
   –ü—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **—Ç–æ–ª—å–∫–æ** –∫–æ—Ä–Ω–µ–≤–æ–π —Ñ–∞–π–ª. –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–ø–∏–∏ –≤ `src/` –∏–ª–∏ `Store/`.

3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:**
   –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ `/root/meetride/botManager.php` –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–Ω:
   ```bash
   cp /root/meetride/botManager.php /var/www/html/meetRiedeBot/botManager.php
   ```

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
- `/var/www/html/meetRiedeBot/logs/webhook_debug.log`
- `/root/meetride/logs/webhook.log`

**–°—Ç–∞—Ç—É—Å:** –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ! üöÄ





