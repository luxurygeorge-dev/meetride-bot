# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –ø–æ–ª–µ–π

**–î–∞—Ç–∞:** 7 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üêõ –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –°–∏–º–ø—Ç–æ–º—ã:
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –ø–æ–ª–µ–π **–ù–ï –ø—Ä–∏—Ö–æ–¥—è—Ç** –≤–æ–¥–∏—Ç–µ–ª—è–º
- –í –ª–æ–≥–∞—Ö: `No OLD values provided for deal XXX, skipping`

### –ü—Ä–∏—á–∏–Ω–∞:
**Bitrix24 –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç OLD –∑–Ω–∞—á–µ–Ω–∏—è –≤ webhook'–µ ONCRMDEALUPDATE**

–§—É–Ω–∫—Ü–∏—è `dealChangeHandle()` –æ–∂–∏–¥–∞–ª–∞ OLD –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ `$_REQUEST['data']['FIELDS']['OLD']`, –Ω–æ Bitrix24 –∏—Ö –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç. –ü–æ—ç—Ç–æ–º—É —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–≥–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å.

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –ò—Å–ø–æ–ª—å–∑—É–µ–º SERVICE –ø–æ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π

–í–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–Ω–∏—è OLD –∑–Ω–∞—á–µ–Ω–∏–π –æ—Ç Bitrix24, —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å:
1. **–•—Ä–∞–Ω–∏—Ç** –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ SERVICE –ø–æ–ª—è—Ö
2. **–°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç** —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å SERVICE –ø–æ–ª—è–º–∏
3. **–û–±–Ω–æ–≤–ª—è–µ—Ç** SERVICE –ø–æ–ª—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

---

## üîß –ß–¢–û –ë–´–õ–û –ò–ó–ú–ï–ù–ï–ù–û

### –§–∞–π–ª: `/var/www/html/meetRiedeBot/botManager.php`

#### –§—É–Ω–∫—Ü–∏—è: `dealChangeHandle()` (—Å—Ç—Ä–æ–∫–∏ 1031-1210)

**–ë—ã–ª–æ:**
```php
// –ü–æ–ª—É—á–∞–µ–º OLD –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ webhook
$oldValues = $_REQUEST['data']['FIELDS']['OLD'] ?? null;

// –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –Ω–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
if (empty($oldValues)) {
    file_put_contents(..., "No OLD values provided, skipping\n", ...);
    return;
}

// –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å OLD –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
$oldAddressFrom = $oldValues[ADDRESS_FROM_FIELD] ?? null;
```

**–°—Ç–∞–ª–æ:**
```php
// –ó–∞–≥—Ä—É–∂–∞–µ–º SERVICE –ø–æ–ª—è –≤–º–µ—Å—Ç–µ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏
$deal = \CRest::call('crm.deal.get', [
    'select' => [
        '*',
        ADDRESS_FROM_FIELD_SERVICE,  // SERVICE: –û—Ç–∫—É–¥–∞
        ADDRESS_TO_FIELD_SERVICE,    // SERVICE: –ö—É–¥–∞
        TRAVEL_DATE_TIME_FIELD_SERVICE, // SERVICE: –í—Ä–µ–º—è
    ]
]);

// –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å SERVICE –ø–æ–ª—è–º–∏
$serviceAddressFrom = $deal[ADDRESS_FROM_FIELD_SERVICE] ?? '';
$currentAddressFrom = $deal[ADDRESS_FROM_FIELD] ?? '';

if ($serviceAddressFrom && $serviceAddressFrom != $currentAddressFrom) {
    // –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ!
    $changes[] = [
        'emoji' => 'üÖ∞Ô∏è',
        'label' => '–û—Ç–∫—É–¥–∞',
        'old' => $serviceAddressFrom,
        'new' => $currentAddressFrom
    ];
    $updateServiceFields[ADDRESS_FROM_FIELD_SERVICE] = $currentAddressFrom;
}
```

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SERVICE –ø–æ–ª–µ–π –ø–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
```php
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
if (!empty($updateServiceFields)) {
    \CRest::call('crm.deal.update', [
        'id' => $dealId,
        'fields' => $updateServiceFields  // –û–±–Ω–æ–≤–ª—è–µ–º SERVICE –ø–æ–ª—è
    ]);
}
```

---

## üìä –û–¢–°–õ–ï–ñ–ò–í–ê–ï–ú–´–ï –ü–û–õ–Ø

### ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç (–µ—Å—Ç—å SERVICE –ø–æ–ª—è):

1. **–¢–æ—á–∫–∞ –ê (–æ—Ç–∫—É–¥–∞)**
   - –û—Å–Ω–æ–≤–Ω–æ–µ: `UF_CRM_1751269147414`
   - SERVICE: `UF_CRM_1751638512`

2. **–¢–æ—á–∫–∞ –ë (–∫—É–¥–∞)**
   - –û—Å–Ω–æ–≤–Ω–æ–µ: `UF_CRM_1751269175432`
   - SERVICE: `UF_CRM_1751638529`

3. **–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ–µ–∑–¥–∫–∏**
   - –û—Å–Ω–æ–≤–Ω–æ–µ: `UF_CRM_1751269222959`
   - SERVICE: `UF_CRM_1751638617`

### ‚ö†Ô∏è TODO (–Ω—É–∂–Ω—ã SERVICE –ø–æ–ª—è):

4. **–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏**
   - –û—Å–Ω–æ–≤–Ω–æ–µ: `UF_CRM_1754228146`
   - SERVICE: ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤ Bitrix24)

5. **–ü–∞—Å—Å–∞–∂–∏—Ä—ã**
   - –û—Å–Ω–æ–≤–Ω–æ–µ: `UF_CRM_1751271798896`
   - SERVICE: ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤ Bitrix24)

---

## üéØ –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ–Ω—è–µ—Ç –∞–¥—Ä–µ—Å –≤ Bitrix24

```
1. –ó–∞—è–≤–∫–∞ –≤ —Å—Ç–∞–¥–∏–∏ PREPAYMENT_INVOICE (–≤–æ–¥–∏—Ç–µ–ª—å –≤–∑—è–ª)
   –¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:
   - –û—Ç–∫—É–¥–∞: "–ê—ç—Ä–æ–ø–æ—Ä—Ç –î–æ–º–æ–¥–µ–¥–æ–≤–æ" (–æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ)
   - –û—Ç–∫—É–¥–∞ SERVICE: "–ê—ç—Ä–æ–ø–æ—Ä—Ç –î–æ–º–æ–¥–µ–¥–æ–≤–æ" (SERVICE –ø–æ–ª–µ)

2. –ú–µ–Ω–µ–¥–∂–µ—Ä –∏–∑–º–µ–Ω—è–µ—Ç: –û—Ç–∫—É–¥–∞ ‚Üí "–ê—ç—Ä–æ–ø–æ—Ä—Ç –®–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ"
   
3. Bitrix24 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook ‚Üí ONCRMDEALUPDATE

4. –§—É–Ω–∫—Ü–∏—è dealChangeHandle() —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ: "–ê—ç—Ä–æ–ø–æ—Ä—Ç –®–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ"
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç SERVICE –ø–æ–ª–µ: "–ê—ç—Ä–æ–ø–æ—Ä—Ç –î–æ–º–æ–¥–µ–¥–æ–≤–æ"
   - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç: "–ê—ç—Ä–æ–ø–æ—Ä—Ç –î–æ–º–æ–¥–µ–¥–æ–≤–æ" ‚â† "–ê—ç—Ä–æ–ø–æ—Ä—Ç –®–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ"
   - –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ! ‚úÖ

5. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—é:
   üÖ∞Ô∏è –û—Ç–∫—É–¥–∞: <s>–ê—ç—Ä–æ–ø–æ—Ä—Ç –î–æ–º–æ–¥–µ–¥–æ–≤–æ</s> ‚ûî –ê—ç—Ä–æ–ø–æ—Ä—Ç –®–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ

6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SERVICE –ø–æ–ª—è:
   - SERVICE –ø–æ–ª–µ ‚Üí "–ê—ç—Ä–æ–ø–æ—Ä—Ç –®–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ"
   
7. –°–ª–µ–¥—É—é—â–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å—Å—è —Å –Ω–æ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

1. **–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∑–∞—è–≤–∫–∞ –≤–∑—è—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–º:**
   - –°—Ç–∞–¥–∏—è: PREPAYMENT_INVOICE –∏–ª–∏ EXECUTING

2. **–ò–∑–º–µ–Ω–∏—Ç–µ –ª—é–±–æ–µ –ø–æ–ª–µ –≤ Bitrix24:**
   - –û—Ç–∫—É–¥–∞
   - –ö—É–¥–∞  
   - –í—Ä–µ–º—è –ø–æ–µ–∑–¥–∫–∏

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
```bash
tail -f /var/www/html/meetRiedeBot/logs/webhook_debug.log
```

**–û–∂–∏–¥–∞–µ–º–æ–µ:**
```
2025-10-07 XX:XX:XX - dealChangeHandle started for deal XXX
2025-10-07 XX:XX:XX - Using SERVICE fields for change detection
2025-10-07 XX:XX:XX - Sending change notification...
2025-10-07 XX:XX:XX - Change notification sent successfully
2025-10-07 XX:XX:XX - SERVICE fields updated
```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram:**
   - –í–æ–¥–∏—Ç–µ–ª—é –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û –î–õ–Ø –ü–ï–†–í–û–ì–û –ó–ê–ü–£–°–ö–ê

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SERVICE –ø–æ–ª–µ–π

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ SERVICE –ø–æ–ª—è –±—É–¥—É—Ç **–ø—É—Å—Ç—ã–º–∏**. –ß—Ç–æ–±—ã —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å:

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞—è–≤–∫–∏**

–í —Ñ—É–Ω–∫—Ü–∏–∏ `driverAcceptHandle()` —É–∂–µ –µ—Å—Ç—å –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:
```php
\CRest::call('crm.deal.update', [
    'id' => $dealId,
    'fields' => [
        ADDRESS_FROM_FIELD_SERVICE => $deal[ADDRESS_FROM_FIELD],
        ADDRESS_TO_FIELD_SERVICE => $deal[ADDRESS_TO_FIELD],
        TRAVEL_DATE_TIME_FIELD_SERVICE => $deal[TRAVEL_DATE_TIME_FIELD],
    ]
]);
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞—è–≤–æ–∫**

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `/root/meetride/cleanup_service_fields.php` –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

---

## üìù –ß–¢–û –î–ê–õ–¨–®–ï

### TODO: –î–æ–±–∞–≤–∏—Ç—å SERVICE –ø–æ–ª—è –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è 2 –ø–æ–ª–µ–π

**–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤ Bitrix24:**

1. **SERVICE –ø–æ–ª–µ –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫**
   - –¢–∏–ø: –°—Ç—Ä–æ–∫–∞
   - –ù–∞–∑–≤–∞–Ω–∏–µ: "–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (—Å–ª—É–∂.)"
   - –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –≤ botManager.php

2. **SERVICE –ø–æ–ª–µ –¥–ª—è –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤**
   - –¢–∏–ø: –°—Ç—Ä–æ–∫–∞ (–∏–ª–∏ —Å–ø–∏—Å–æ–∫)
   - –ù–∞–∑–≤–∞–Ω–∏–µ: "–ü–∞—Å—Å–∞–∂–∏—Ä—ã (—Å–ª—É–∂.)"
   - –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –≤ botManager.php

---

## ‚úÖ –ò–¢–û–ì

**–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –ò–°–ü–†–ê–í–õ–ï–ù–ê! **

–¢–µ–ø–µ—Ä—å –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑—É—è SERVICE –ø–æ–ª—è –≤–º–µ—Å—Ç–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö OLD –∑–Ω–∞—á–µ–Ω–∏–π –æ—Ç Bitrix24.

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∞–¥—Ä–µ—Å–∞ –ê
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∞–¥—Ä–µ—Å–∞ –ë
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—é
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SERVICE –ø–æ–ª–µ–π

### –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- ‚ö†Ô∏è SERVICE –ø–æ–ª—è –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫
- ‚ö†Ô∏è SERVICE –ø–æ–ª—è –¥–ª—è –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤

---

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
- `/var/www/html/meetRiedeBot/botManager.php` ‚úÖ
- `/root/meetride/botManager.php` ‚úÖ

**–ë—ç–∫–∞–ø:**
- `/var/www/html/meetRiedeBot/botManager.php.backup_before_fix`

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ

